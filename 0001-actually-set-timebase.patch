From 8f8007b06a44218b68ec396569bd1c749774dc43 Mon Sep 17 00:00:00 2001
From: Travis Thieman <travis.thieman@gmail.com>
Date: Thu, 8 May 2025 07:30:57 -0400
Subject: [PATCH 1/1] actually set timebase

---
 Limelight/Stream/VideoDecoderRenderer.m | 23 +++++++++++++++++++++++
 1 file changed, 23 insertions(+)

diff --git a/Limelight/Stream/VideoDecoderRenderer.m b/Limelight/Stream/VideoDecoderRenderer.m
index 08c6036..a4e2a61 100644
--- a/Limelight/Stream/VideoDecoderRenderer.m
+++ b/Limelight/Stream/VideoDecoderRenderer.m
@@ -644,6 +644,29 @@ int DrSubmitDecodeUnit(PDECODE_UNIT decodeUnit, CFTimeInterval targetTimestamp);
     };
 
     CMSampleBufferRef sampleBuffer;
+    
+    if (du->frameNumber == 1) {
+        // On first frame, set timebase to equal the initial presentation time.
+        // This will sync the display clocks between client and server
+        CMTimebaseRef timebase = NULL;
+        OSStatus status = CMTimebaseCreateWithSourceClock(CFAllocatorGetDefault(),
+                                                          CMClockGetHostTimeClock(),
+                                                          &timebase);
+        if (status != noErr) {
+            // Handle error
+        }
+        
+        // Set the timebase to the initial pts here
+        CMTimebaseSetTime(timebase, sampleTiming.presentationTimeStamp);
+        CMTimebaseSetRate(timebase, 1.0);
+        
+        [displayLayer setControlTimebase:timebase];
+    }
+    
+    Log(LOG_I, @"[%f] frame %d got presentation time %f",
+        CACurrentMediaTime(), du->frameNumber,
+        targetTimestamp);
+    
     status = CMSampleBufferCreateReady(kCFAllocatorDefault,
                                   frameBlockBuffer,
                                   formatDesc, 1, 1,
-- 
2.47.1

